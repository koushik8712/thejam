{% extends "base.html" %}

{% block title %}{{ get_text('search_animals') }}{% endblock %}

{% block content %}
<div class="container">
    <a href="{{ url_for('dashboard') }}" class="reset-button" style="float: right; margin-bottom: 10px;">
        ← {{ get_text('back_to_dashboard') }}
    </a>

    <div class="filter-container">
        <h2>{{ get_text('search_animals') }}</h2>
        <form method="POST" id="filterForm">
            <label for="filter_by">{{ get_text('filter by') }}</label>
            <select name="filter_by" id="filter_by" onchange="toggleFilterInputs()">
                <option value="">{{ get_text('select filter') }}</option>
                <option value="price" {% if filter_by == 'price' %}selected{% endif %}>
                    {{ get_text('price') }}
                </option>
                <option value="category" {% if filter_by == 'category' %}selected{% endif %}>
                    {{ get_text('category') }}
                </option>
                <option value="location" {% if filter_by == 'location' %}selected{% endif %}>
                    {{ get_text('location') }}
                </option>
            </select>

            <div id="priceFilter" style="display: {% if filter_by == 'price' %}block{% else %}none{% endif %};">
                <label for="price_min">{{ get_text('min price') }}</label>
                <input type="number" name="price_min" id="price_min" value="{{ price_min }}">
                <label for="price_max">{{ get_text('max price') }}</label>
                <input type="number" name="price_max" id="price_max" value="{{ price_max }}">
                <select name="sort_price" id="sort_price">
                    <option value="">{{ get_text('select sort') }}</option>
                    <option value="high_to_low" {% if sort_price == 'high_to_low' %}selected{% endif %}>
                        {{ get_text('high to low price') }}
                    </option>
                    <option value="low_to_high" {% if sort_price == 'low_to_high' %}selected{% endif %}>
                        {{ get_text('low to high price') }}
                    </option>
                </select>
            </div>

            <div id="categoryFilter" style="display: {% if filter_by == 'category' %}block{% else %}none{% endif %};">
                <select name="category" id="category">
                    <option value="">{{ get_text('select category') }}</option>
                    <option value="cows" {% if category == 'cows' %}selected{% endif %}>
                        {{ get_text('cows') }}
                    </option>
                    <option value="buffaloes" {% if category == 'buffaloes' %}selected{% endif %}>
                        {{ get_text('buffaloes') }}
                    </option>
                    <option value="goats" {% if category == 'goats' %}selected{% endif %}>
                        {{ get_text('goats') }}
                    </option>
                    <option value="sheep" {% if category == 'sheep' %}selected{% endif %}>
                        {{ get_text('sheep') }}
                    </option>
                </select>
            </div>

            <div id="locationFilter" style="display: {% if filter_by == 'location' %}block{% else %}none{% endif %};">
                <input type="text" name="location" id="location" 
                       value="{{ location }}" placeholder="{{ get_text('enter_location') }}">
            </div>

            <button type="submit">{{ get_text('apply_filters') }}</button>
            <a href="{{ url_for('search_animals') }}" class="reset-button">
                {{ get_text('reset_search') }}
            </a>
        </form>
    </div>

    <div class="animals-wrapper">
        {% for animal in animals %}
            <div class="animal-card">
                <img src="{{ url_for('static', filename='uploads/' + animal.photos.split(',')[0]) }}" 
                     alt="{{ animal.category }}">
                <div class="animal-info">
                    <h3>{{ animal.category }}{% if animal.breed %} - {{ animal.breed }}{% endif %}</h3>
                    <p><strong>{{ get_text('price') }}:</strong> ₹{{ animal.cost }}</p>
                    <p><strong>{{ get_text('location') }}:</strong> {{ animal.location }}</p>
                    {% if animal.age %}
                        <p><strong>{{ get_text('age') }}:</strong> {{ animal.age }} {{ get_text('years') }}</p>
                    {% endif %}
                    <p><strong>{{ get_text('weight') }}:</strong> {{ animal.weight }}kg</p>
                    
                    <div class="animal-actions">
                        <a href="https://wa.me/+91{{ animal.contact_number }}?text={{ get_text('interested_in_animal') }} {{ animal.category }}" 
                           target="_blank">{{ get_text('contact_on_whatsapp') }}</a>
                        <a href="sms:+91{{ animal.contact_number }}?body={{ get_text('interested_in_animal') }} {{ animal.category }}">
                            {{ get_text('contact_via_sms') }}</a>
                        <label class="ui-bookmark">
                            <input type="checkbox" data-animal-id="{{ animal.id }}" 
                                   {% if animal.id in saved_animals %}checked{% endif %}>
                            <div class="bookmark">
                                <svg viewBox="0 0 16 16" class="bi bi-heart-fill" height="25" width="25">
                                    <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                                </svg>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
function toggleFilterInputs() {
    const filterBy = document.getElementById('filter_by').value;
    document.getElementById('priceFilter').style.display = 
        filterBy === 'price' ? 'block' : 'none';
    document.getElementById('categoryFilter').style.display = 
        filterBy === 'category' ? 'block' : 'none';
    document.getElementById('locationFilter').style.display = 
        filterBy === 'location' ? 'block' : 'none';
}

document.querySelectorAll('.ui-bookmark input').forEach(input => {
    const animalId = input.getAttribute('data-animal-id');
    input.addEventListener('change', function(e) {
        e.preventDefault();
        this.disabled = true;
        
        fetch(`/save_animal/${animalId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.checked = data.saved;
            } else if (data.message === 'Please log in first') {
                window.location.href = '/login';
            } else {
                alert(data.message || 'An error occurred');
                this.checked = !this.checked;
            }
        })
        .catch(err => {
            console.error('Error:', err);
            this.checked = !this.checked;
            alert('Failed to save animal. Please try again.');
        })
        .finally(() => {
            this.disabled = false;
        });
    });
});
</script>
{% endblock %}
